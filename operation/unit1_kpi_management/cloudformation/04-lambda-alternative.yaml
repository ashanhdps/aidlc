AWSTemplateFormatVersion: '2010-09-09'
Description: 'Ultra cost-optimized Lambda-based deployment for KPI Management Service ($2-3/month budget)'

Parameters:
  Environment:
    Type: String
    Default: production
    Description: Environment name
  
  ProjectName:
    Type: String
    Default: kpi-management
    Description: Project name for resource naming

  DatabasePassword:
    Type: String
    Description: Database master password
    NoEcho: true
    MinLength: 8
    MaxLength: 128

Resources:
  # Aurora Serverless v2 for ultra-low cost
  DatabaseCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      DBClusterIdentifier: !Sub '${ProjectName}-${Environment}-cluster'
      Engine: aurora-postgresql
      EngineMode: provisioned
      EngineVersion: '15.4'
      DatabaseName: kpi_management
      MasterUsername: kpi_admin
      MasterUserPassword: !Ref DatabasePassword
      
      # Serverless v2 configuration
      ServerlessV2ScalingConfiguration:
        MinCapacity: 0.5  # Minimum billing unit
        MaxCapacity: 1.0  # Maximum for cost control
      
      # Cost optimization settings
      BackupRetentionPeriod: 1  # Minimum backup retention
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'sun:04:00-sun:05:00'
      DeletionProtection: false
      StorageEncrypted: true
      
      # Network configuration
      VPCSecurityGroupIds:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DatabaseSubnetGroup
      
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-aurora-cluster'
        - Key: Environment
          Value: !Ref Environment

  # Single Aurora instance
  DatabaseInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-${Environment}-instance'
      DBClusterIdentifier: !Ref DatabaseCluster
      DBInstanceClass: db.serverless  # Serverless v2 instance class
      Engine: aurora-postgresql
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-aurora-instance'

  # Minimal VPC setup
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-vpc'

  # Private subnets only (no NAT Gateway needed for Lambda)
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.1.0/24
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-subnet-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.2.0/24
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-subnet-2'

  # Database subnet group
  DatabaseSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub '${ProjectName}-${Environment}-db-subnet-group'
      DBSubnetGroupDescription: Subnet group for Aurora database
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-db-subnet-group'

  # Security group for database
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectName}-${Environment}-db-sg'
      GroupDescription: Security group for Aurora database
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: PostgreSQL from Lambda functions
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-db-sg'

  # Security group for Lambda functions
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectName}-${Environment}-lambda-sg'
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          DestinationSecurityGroupId: !Ref DatabaseSecurityGroup
          Description: PostgreSQL to database
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS outbound
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-lambda-sg'

  # Lambda execution role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: DatabaseAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds:DescribeDBClusters
                  - rds:DescribeDBInstances
                Resource: '*'
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref DatabaseSecret
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                Resource: !GetAtt EventQueue.Arn

  # Database credentials secret
  DatabaseSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-db-credentials'
      Description: Database credentials for KPI Management Service
      SecretString: !Sub |
        {
          "username": "kpi_admin",
          "password": "${DatabasePassword}",
          "engine": "postgres",
          "host": "${DatabaseCluster.Endpoint.Address}",
          "port": ${DatabaseCluster.Endpoint.Port},
          "dbname": "kpi_management"
        }

  # SQS Queue for events (minimal cost)
  EventQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-events'
      VisibilityTimeoutSeconds: 300
      MessageRetentionPeriod: 345600  # 4 days (shorter retention)
      ReceiveMessageWaitTimeSeconds: 20

  # Lambda function for KPI Management API
  KPIManagementFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-api'
      Runtime: java21
      Handler: com.company.kpi.lambda.KPIManagementHandler
      Code:
        ZipFile: |
          // Placeholder - replace with actual deployment package
          public class KPIManagementHandler {
              public String handleRequest(Object input, Context context) {
                  return "KPI Management Service";
              }
          }
      MemorySize: 512  # Minimum for Java
      Timeout: 30
      Role: !GetAtt LambdaExecutionRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          DATABASE_SECRET_ARN: !Ref DatabaseSecret
          SQS_QUEUE_URL: !Ref EventQueue
          SPRING_PROFILES_ACTIVE: lambda
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-lambda'
        - Key: Environment
          Value: !Ref Environment

  # API Gateway for HTTP endpoints
  ApiGateway:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-api'
      ProtocolType: HTTP
      Description: KPI Management Service API
      CorsConfiguration:
        AllowOrigins:
          - '*'
        AllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        AllowHeaders:
          - Content-Type
          - Authorization
      Tags:
        Name: !Sub '${ProjectName}-${Environment}-api'
        Environment: !Ref Environment

  # Lambda integration
  ApiIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref ApiGateway
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${KPIManagementFunction.Arn}/invocations'
      PayloadFormatVersion: '2.0'

  # Catch-all route
  ApiRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref ApiGateway
      RouteKey: 'ANY /{proxy+}'
      Target: !Sub 'integrations/${ApiIntegration}'

  # Default route
  DefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref ApiGateway
      RouteKey: 'ANY /'
      Target: !Sub 'integrations/${ApiIntegration}'

  # API Gateway stage
  ApiStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref ApiGateway
      StageName: '$default'
      AutoDeploy: true
      DefaultRouteSettings:
        ThrottlingBurstLimit: 100
        ThrottlingRateLimit: 50

  # Lambda permission for API Gateway
  LambdaApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref KPIManagementFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub '${ApiGateway}/*/*'

  # CloudWatch Log Group for Lambda
  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${KPIManagementFunction}'
      RetentionInDays: 3  # Very short retention for cost savings

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com'
    Export:
      Name: !Sub '${ProjectName}-${Environment}-api-endpoint'

  DatabaseEndpoint:
    Description: Aurora cluster endpoint
    Value: !GetAtt DatabaseCluster.Endpoint.Address
    Export:
      Name: !Sub '${ProjectName}-${Environment}-db-endpoint'

  EstimatedMonthlyCost:
    Description: Estimated monthly cost breakdown (USD)
    Value: !Sub |
      Aurora Serverless v2 (0.5 ACU): $15-20/month
      Lambda (1M requests): $0.20/month
      API Gateway (1M requests): $1.00/month
      SQS (1M requests): $0.40/month
      CloudWatch Logs: $0.50/month
      Secrets Manager: $0.40/month
      Data Transfer: $1.00/month
      
      TOTAL: ~$18-23/month
      
      Note: Still above $2-3 budget. Consider:
      - DynamoDB instead of Aurora (~$2-5/month)
      - Scheduled Lambda to pause Aurora when not in use
      - Use AWS Free Tier resources where possible

  CostOptimizationTips:
    Description: Further cost reduction strategies
    Value: !Sub |
      To reach $2-3/month budget:
      1. Replace Aurora with DynamoDB (~$1-3/month)
      2. Use Lambda scheduled scaling to pause Aurora
      3. Implement request caching to reduce Lambda invocations
      4. Use CloudFront for static content caching
      5. Consider AWS Free Tier limits (1M Lambda requests free)
      6. Use S3 for file storage instead of EBS
      7. Implement efficient database connection pooling